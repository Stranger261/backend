name: Deploy Node Services to CyberPanel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------
      # Create services directory if it doesn't exist
      # ---------------------------
      - name: Create services directory on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          script: |
            # Check if the services folder exists, if not, create it
            if [ ! -d "/home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services" ]; then
              mkdir -p /home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services
            fi

      # ---------------------------
      # Upload services folder contents to the server
      # ---------------------------
      - name: Upload service folders to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          source: "services/*"  # This will upload everything inside the services folder
          target: "/home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services"  # Target is the services folder directly
          rm: true  # This ensures that the target folder gets cleaned before upload
          recursive: true
          exclude: "node_modules, .git, .github, test"  # Exclude unnecessary folders

      # ---------------------------
      # Install dependencies & restart services
      # ---------------------------
      - name: Install & restart services on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          script: |
            cd /home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services

            for d in */ ; do
              if [ -f "$d/package.json" ]; then
                echo "Installing dependencies for $d"
                cd "$d"
                npm install --production
                pm2 restart "$d" || pm2 start npm --name "$d" -- run start
                cd ..
              fi
            done
