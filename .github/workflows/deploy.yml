name: Deploy Node Services to CyberPanel

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # ---------------------------
      # Upload all services via SFTP
      # ---------------------------
      - name: Upload services to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          script: |
            # Create services folder if it doesn't exist
            mkdir -p /home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services

      - name: Upload service folders
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          source: "services/*"
          target: "/home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services"
          rm: false
          recursive: true
          exclude: "node_modules, .git, .github, test"

      # ---------------------------
      # Install dependencies & restart services
      # ---------------------------
      - name: Install & restart services on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: 2298
          script: |
            cd /home/core1.health-ease-hospital.com/auth.health-ease-hospital.com/services

            for d in */ ; do
              if [ -f "$d/package.json" ]; then
                echo "Installing dependencies for $d"
                cd "$d"
                npm install --production
                pm2 restart "$d" || pm2 start npm --name "$d" -- run start
                cd ..
              fi
            done
